import React, { useState, useEffect, useMemo } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area } from 'recharts';
import { Calculator, TrendingUp, DollarSign, Calendar, ArrowRight, Table } from 'lucide-react';

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>
    {children}
  </div>
);

const InputGroup = ({ label, value, onChange, prefix = "", suffix = "", step = "0.1" }) => (
  <div className="flex flex-col gap-1">
    <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">{label}</label>
    <div className="relative">
      {prefix && <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">{prefix}</span>}
      <input
        type="number"
        value={value}
        onChange={(e) => onChange(parseFloat(e.target.value) || 0)}
        step={step}
        className={`w-full p-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all font-medium ${prefix ? 'pl-7' : ''} ${suffix ? 'pr-8' : ''}`}
      />
      {suffix && <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">{suffix}</span>}
    </div>
  </div>
);

const StatBox = ({ label, value, subtext, color = "text-slate-900", highlight = false }) => (
  <div className={`p-4 rounded-lg ${highlight ? 'bg-blue-50 border border-blue-100' : 'bg-slate-50'}`}>
    <div className="text-sm text-slate-500 mb-1">{label}</div>
    <div className={`text-2xl font-bold ${color}`}>{value}</div>
    {subtext && <div className="text-xs text-slate-400 mt-1">{subtext}</div>}
  </div>
);

export default function MortgageCalculator() {
  // --- State ---
  const [loanAmount, setLoanAmount] = useState(400000);
  const [rate30, setRate30] = useState(6.5);
  const [rate50, setRate50] = useState(7.5);
  const [returnRate, setReturnRate] = useState(8.0);
  const [viewMode, setViewMode] = useState('chart'); // 'chart' or 'table'

  // --- Calculations ---
  const results = useMemo(() => {
    // Monthly Rates
    const r30 = rate30 / 100 / 12;
    const r50 = rate50 / 100 / 12;
    const rInv = returnRate / 100 / 12;

    // Terms in Months
    const n30 = 30 * 12;
    const n50 = 50 * 12;

    // Monthly Payments (PMT Formula)
    const pmt30 = (loanAmount * r30 * Math.pow(1 + r30, n30)) / (Math.pow(1 + r30, n30) - 1);
    const pmt50 = (loanAmount * r50 * Math.pow(1 + r50, n50)) / (Math.pow(1 + r50, n50) - 1);

    const monthlySavings = pmt30 - pmt50;
    const isSavingsPositive = monthlySavings > 0;

    // Generate Schedule
    let balance30 = loanAmount;
    let balance50 = loanAmount;
    let investmentValue = 0;
    let totalInterest30 = 0;
    let totalInterest50 = 0;

    const data = [];
    const yearlyData = [];

    // We model up to 50 years (600 months)
    for (let month = 1; month <= 600; month++) {
      // 30 Year Logic
      let interest30 = 0;
      let principal30 = 0;
      if (month <= n30) {
        interest30 = balance30 * r30;
        principal30 = pmt30 - interest30;
        balance30 -= principal30;
        totalInterest30 += interest30;
      } else {
        balance30 = 0;
      }

      // 50 Year Logic
      let interest50 = balance50 * r50;
      let principal50 = pmt50 - interest50;
      balance50 -= principal50;
      totalInterest50 += interest50;

      // Investment Logic (Investing the difference)
      if (isSavingsPositive) {
        // Add growth to existing pot
        investmentValue = investmentValue * (1 + rInv);
        // Add new contribution (only if 30yr term is still active, otherwise you have even MORE cashflow, 
        // but usually comparisons stop contributing the "difference" once the 30y is paid off, 
        // OR they contribute the full 30y payment amount. 
        // METHOD: We will assume we invest the difference for 30 years. 
        // After year 30, the 30y loan is done, so the user technically has $PMT30 available.
        // To keep it simple and fair to the "Savings" model, we'll continue simulating the growth 
        // of the pot, but stop adding the monthly difference if desired. 
        // However, standard comparisons usually invest the specific difference monthly for the duration of the comparison.
        // Let's assume we invest the "Savings" for the full 50 years to see long term impact? 
        // Actually, the "Savings" disappear after year 30 because the 30-year person has NO payment.
        
        // REVISED LOGIC FOR ACCURACY:
        // Months 1-360: Invest (PMT30 - PMT50).
        // Months 361-600: The 30-year borrower has $0 payment. The 50-year borrower pays PMT50.
        // The 30-year borrower could now invest their ENTIRE old payment. 
        // To compare strictly "Lower Payment Strategy", we usually only look at the investment of the savings generated by the 50y loan.
        
        if (month <= n30) {
            investmentValue += monthlySavings;
        }
      }

      if (month % 12 === 0 || month === 1) {
        yearlyData.push({
          year: Math.ceil(month / 12),
          balance30: Math.max(0, balance30),
          balance50: Math.max(0, balance50),
          investmentValue: investmentValue,
          netWorth50Diff: investmentValue - Math.max(0, balance50) // Rough equity calc relative to cash
        });
      }

      data.push({
        month,
        year: (month/12).toFixed(1),
        balance30: Math.max(0, balance30),
        balance50: Math.max(0, balance50),
        investmentValue,
        interest30,
        interest50,
        principal30,
        principal50
      });
    }

    return {
      pmt30,
      pmt50,
      monthlySavings,
      totalInterest30,
      totalInterest50,
      investmentAt30: data[359].investmentValue,
      investmentAt50: data[599].investmentValue,
      data,
      yearlyData
    };
  }, [loanAmount, rate30, rate50, returnRate]);

  // Formatting helpers
  const formatCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
  const formatCurrencyCents = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val);

  return (
    <div className="p-4 max-w-6xl mx-auto bg-slate-50 min-h-screen font-sans text-slate-900">
      
      {/* Header */}
      <div className="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <Calculator className="w-6 h-6 text-blue-600" />
            Mortgage Strategy Modeler
          </h1>
          <p className="text-slate-500 text-sm mt-1">Compare 30-year vs. 50-year amortization with investment opportunity cost.</p>
        </div>
        
        <div className="flex bg-white p-1 rounded-lg border border-slate-200">
          <button 
            onClick={() => setViewMode('chart')}
            className={`px-4 py-1.5 rounded-md text-sm font-medium transition-colors ${viewMode === 'chart' ? 'bg-blue-600 text-white' : 'text-slate-600 hover:bg-slate-50'}`}
          >
            Visual Model
          </button>
          <button 
            onClick={() => setViewMode('table')}
            className={`px-4 py-1.5 rounded-md text-sm font-medium transition-colors ${viewMode === 'table' ? 'bg-blue-600 text-white' : 'text-slate-600 hover:bg-slate-50'}`}
          >
            Schedule Table
          </button>
        </div>
      </div>

      {/* Main Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        {/* Left Column: Inputs & Monthly Summary */}
        <div className="lg:col-span-4 space-y-6">
          <Card className="p-5">
            <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
              <DollarSign className="w-5 h-5 text-green-600" />
              Loan Parameters
            </h2>
            <div className="space-y-4">
              <InputGroup label="Loan Amount" value={loanAmount} onChange={setLoanAmount} prefix="$" step="1000" />
              <div className="grid grid-cols-2 gap-4">
                <InputGroup label="30-Yr Rate" value={rate30} onChange={setRate30} suffix="%" />
                <InputGroup label="50-Yr Rate" value={rate50} onChange={setRate50} suffix="%" />
              </div>
              <div className="pt-4 border-t border-slate-100">
                <InputGroup label="Est. Investment Return (S&P 500)" value={returnRate} onChange={setReturnRate} suffix="%" />
                <p className="text-xs text-slate-400 mt-2">
                  Historic S&P 500 average inflation-adjusted return is ~7-8%.
                </p>
              </div>
            </div>
          </Card>

          <Card className="p-5">
            <h2 className="font-bold text-lg mb-4">Monthly Breakdown</h2>
            <div className="space-y-4">
              <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                <span className="text-sm font-medium text-slate-600">30-Year P&I</span>
                <span className="text-lg font-bold text-slate-800">{formatCurrencyCents(results.pmt30)}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                <span className="text-sm font-medium text-slate-600">50-Year P&I</span>
                <span className="text-lg font-bold text-slate-800">{formatCurrencyCents(results.pmt50)}</span>
              </div>
              
              <div className="relative">
                <div className="absolute inset-0 flex items-center">
                  <div className="w-full border-t border-slate-200"></div>
                </div>
                <div className="relative flex justify-center text-xs uppercase">
                  <span className="bg-white px-2 text-slate-500">Difference</span>
                </div>
              </div>

              <div className={`flex flex-col p-4 rounded-lg border-2 ${results.monthlySavings > 0 ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'}`}>
                <span className="text-sm font-medium text-slate-600 mb-1">Investable Savings</span>
                <div className="flex items-end gap-2">
                  <span className={`text-2xl font-bold ${results.monthlySavings > 0 ? 'text-green-700' : 'text-red-700'}`}>
                    {results.monthlySavings > 0 ? '+' : ''}{formatCurrencyCents(results.monthlySavings)}
                  </span>
                  <span className="text-xs text-slate-500 mb-1">/ month</span>
                </div>
                {results.monthlySavings <= 0 && (
                  <span className="text-xs text-red-600 mt-2">
                    Warning: 50-year rate is too high to yield savings.
                  </span>
                )}
              </div>
            </div>
          </Card>
        </div>

        {/* Right Column: Visualization & Analysis */}
        <div className="lg:col-span-8 space-y-6">
          
          {/* Top Stats Row */}
          <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <StatBox 
              label="Portfolio at Year 30" 
              value={formatCurrency(results.investmentAt30)} 
              subtext="Total accumulated from investing savings"
              color="text-green-600"
              highlight={true}
            />
            <StatBox 
              label="30-Yr Total Interest" 
              value={formatCurrency(results.totalInterest30)} 
              subtext="Cost of borrowing (30y)"
            />
            <StatBox 
              label="50-Yr Total Interest" 
              value={formatCurrency(results.totalInterest50)} 
              subtext="Cost of borrowing (50y)"
              color="text-red-600"
            />
          </div>

          {/* Main Content Area */}
          <Card className="p-6 h-[500px] flex flex-col">
            {viewMode === 'chart' ? (
              <>
                <div className="mb-6">
                  <h3 className="font-bold text-lg text-slate-800">Projection Model (30 vs 50 Years)</h3>
                  <p className="text-sm text-slate-500">
                    Lines show the loan balance decreasing over time vs. the investment portfolio growing.
                    <br />Note: At Year 30, the 30-year loan is paid off ($0 balance), while the 50-year loan still owes substantial principal.
                  </p>
                </div>
                <div className="flex-1 w-full min-h-0">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={results.yearlyData} margin={{ top: 5, right: 20, left: 10, bottom: 5 }}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                      <XAxis 
                        dataKey="year" 
                        label={{ value: 'Years', position: 'insideBottomRight', offset: -5 }} 
                        tick={{fontSize: 12}}
                      />
                      <YAxis 
                        tickFormatter={(value) => `$${value / 1000}k`} 
                        tick={{fontSize: 12}}
                        width={60}
                      />
                      <Tooltip 
                        formatter={(value) => formatCurrency(value)}
                        labelFormatter={(label) => `Year ${label}`}
                        contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}
                      />
                      <Legend wrapperStyle={{ paddingTop: '20px' }} />
                      <Line 
                        type="monotone" 
                        dataKey="balance30" 
                        name="30-Year Loan Balance" 
                        stroke="#3b82f6" 
                        strokeWidth={2} 
                        dot={false} 
                      />
                      <Line 
                        type="monotone" 
                        dataKey="balance50" 
                        name="50-Year Loan Balance" 
                        stroke="#ef4444" 
                        strokeWidth={2} 
                        dot={false} 
                      />
                      <Line 
                        type="monotone" 
                        dataKey="investmentValue" 
                        name="Investment Portfolio" 
                        stroke="#10b981" 
                        strokeWidth={2} 
                        dot={false} 
                      />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </>
            ) : (
              <div className="flex flex-col h-full">
                <div className="flex justify-between items-end mb-4">
                  <div>
                    <h3 className="font-bold text-lg text-slate-800">Amortization Schedule</h3>
                    <p className="text-sm text-slate-500">Monthly detailed breakdown.</p>
                  </div>
                  <div className="text-xs text-slate-400 italic">
                    Showing first 360 months (30 years) for brevity
                  </div>
                </div>
                <div className="flex-1 overflow-auto border border-slate-200 rounded-lg">
                  <table className="w-full text-sm text-left">
                    <thead className="bg-slate-50 text-slate-500 font-medium sticky top-0 z-10">
                      <tr>
                        <th className="p-3 border-b">Month</th>
                        <th className="p-3 border-b">30y Balance</th>
                        <th className="p-3 border-b">50y Balance</th>
                        <th className="p-3 border-b bg-green-50 text-green-700">Savings Invested</th>
                        <th className="p-3 border-b">Investment Total</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {results.data.slice(0, 360).map((row) => (
                        <tr key={row.month} className="hover:bg-slate-50">
                          <td className="p-3 text-slate-500">{row.month}</td>
                          <td className="p-3 font-mono">{formatCurrencyCents(row.balance30)}</td>
                          <td className="p-3 font-mono">{formatCurrencyCents(row.balance50)}</td>
                          <td className="p-3 font-mono bg-green-50/50 text-green-700">
                            {row.month <= 360 ? formatCurrencyCents(results.monthlySavings) : '$0.00'}
                          </td>
                          <td className="p-3 font-mono font-bold text-green-600">{formatCurrencyCents(row.investmentValue)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </Card>

          {/* Analysis Blurb */}
          <Card className="p-5 bg-blue-50 border-blue-100">
            <h4 className="font-bold text-blue-800 mb-2 flex items-center gap-2">
              <TrendingUp className="w-4 h-4" />
              The Verdict at Year 30
            </h4>
            <div className="text-sm text-slate-700 space-y-2">
              <p>
                At year 30, the 30-year loan is fully paid off. The 50-year loan still has a balance of <strong>{formatCurrency(results.data[359].balance50)}</strong>.
              </p>
              <p>
                However, if you strictly invested the difference ({formatCurrencyCents(results.monthlySavings)}/mo), your investment portfolio would be worth <strong>{formatCurrency(results.investmentAt30)}</strong>.
              </p>
              <p className="font-semibold mt-2">
                Net Result: {results.investmentAt30 - results.data[359].balance50 > 0 
                  ? <span className="text-green-600">The 50-year strategy is ahead by {formatCurrency(results.investmentAt30 - results.data[359].balance50)}.</span>
                  : <span className="text-red-600">The 30-year strategy is ahead by {formatCurrency(Math.abs(results.investmentAt30 - results.data[359].balance50))}.</span>
                }
              </p>
            </div>
          </Card>

        </div>
      </div>
    </div>
  );
}
